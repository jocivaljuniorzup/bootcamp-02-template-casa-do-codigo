package br.com.jocivaldiaszup.bootcamp02templatecasadocodigo.purchase;

import br.com.jocivaldiaszup.bootcamp02templatecasadocodigo.author.Author;
import br.com.jocivaldiaszup.bootcamp02templatecasadocodigo.book.Book;
import br.com.jocivaldiaszup.bootcamp02templatecasadocodigo.book.BookBuilder;
import br.com.jocivaldiaszup.bootcamp02templatecasadocodigo.category.Category;
import br.com.jocivaldiaszup.bootcamp02templatecasadocodigo.country.Country;
import br.com.jocivaldiaszup.bootcamp02templatecasadocodigo.country.CountryState;
import br.com.jocivaldiaszup.bootcamp02templatecasadocodigo.coupon.Coupon;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.springframework.util.Assert;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.HashSet;
import java.util.Set;

public class PurchaseTest {

    Country country = new Country("Brazil");
    CountryState countryState = new CountryState("Minas Gerais", country);
    Coupon coupon = new Coupon("code", BigDecimal.TEN, LocalDate.now().plusDays(1l));

    Book book = new BookBuilder().setBookAbstract("abstract")
            .setAuthor(new Author("name", "email@email.com", "descripton"))
            .setCategory(new Category("name"))
            .setIsbn("123")
            .setPages(1000)
            .setPublicationDate(LocalDate.now().plusDays(1l))
            .setSummary("summary")
            .setTitle("title")
            .setValue(BigDecimal.valueOf(100))
            .build();

    Set<PurchaseItem> purchaseItemSet = new HashSet<PurchaseItem>(Set.of(new PurchaseItem(book, 1, BigDecimal.valueOf(100))));

    PurchaseBuilder purchaseBuilder = new PurchaseBuilder()
            .setFirstName("firstname")
            .setLastName("lastname")
            .setEmail("email@email.com.br")
            .setCpfCnpj("123456789")
            .setTelephoneNumber("123465789")
            .setAddress("Address")
            .setComplement("complement")
            .setZipCode("123456789")
            .setCity("City")
            .setCountry(country)
            .setCountryState(countryState)
            .setStatus(PurchaseStatus.OPENED)
            .setTotalValue(BigDecimal.valueOf(100))
            .setPurchaseItemSet(purchaseItemSet);

    @Test
    void givenValidCoupon_whenApplyCoupon_thenAdjustValue() {
        Purchase purchase = purchaseBuilder
                .setCoupon(coupon)
                .build();

        BigDecimal originalValue = purchase.getTotalValue();
        purchase.applyCoupon();
        BigDecimal finalValue = purchase.getTotalValue();

        // 10% of discount
        originalValue = originalValue.multiply(BigDecimal.valueOf(0.9));

        Assertions.assertEquals(originalValue, finalValue);
        Assertions.assertEquals(purchase.getStatus(), PurchaseStatus.COUPONAPPLIED);
    }

    @Test
    void givenValidPurchase_whenValidateTotal_thenReturnTrue() {
        Purchase purchase = purchaseBuilder
                .setCoupon(null)
                .build();

        BigDecimal expectedValue = BigDecimal.valueOf(100);

        BigDecimal calculatedValue = purchase.calculateTotalValue();

        Assertions.assertTrue(purchase.validateTotal());
        Assertions.assertTrue(expectedValue.compareTo(calculatedValue) == 0);
    }

    @Test
    void givenInvalidTotalValue_whenValidateTotal_thenReturnFalse(){
        BigDecimal expectedValue = BigDecimal.valueOf(200);

        Purchase purchase = purchaseBuilder
                .setCoupon(null)
                .setTotalValue(expectedValue)
                .build();

        BigDecimal calculatedValue = purchase.calculateTotalValue();

        Assertions.assertFalse(purchase.validateTotal());
        Assertions.assertFalse(expectedValue.compareTo(calculatedValue) == 0);
    }
}
